# 23장: 실행 컨텍스트

실행 컨텍스트를 이해하면 알 수 있는 것 

- 스코프를 기반으로 식별자와 바인딩된 값을 관리하는 방식

- 호이스팅이 발생하는 이유

- 클로저의 동작 방식

- 태스크 큐와 함께 동작하는 이벤트 핸들러

- 비동기 처리의 동작 방식



## 23.1 소스코드의 타입

- 전역 코드: 전역 스코프 생성, var 전역 변수와 함수 선언문 전역 함수를 전여 ㄱ객체의 플퍼티와 메서드로 바인딩

- 함수 코드: 지역 스코프 생성, 지역변수-매개변수-arguments 객체 관리

- eval 코드: strict mode에서 독자적인 스코프 생성

- 모듈 코드: 모듈별로 독립적인 모듈 스코프 생성



## 23.2 소스코드의 평가와 실행

- 소스코드 평가 과정
  
  - 실행 컨텍스트 생성
  
  - 변수, 함수 등의 선언문만 먼저 실행해, 식별자를 키로 스코프에 등록

- 소스코드 실행 과정(런타임)
  
  - 변수나 함수의 참조를 스코프에 검색해서 취득



## 23.3 실행 컨텍스트의 역할

자바스크립트 엔진이 코드를 평가하고 실행하는 과정

1. 전역 코드 평가
   
   - 전역 코드 변수, 함수 선언문 먼저 실행 -> 전역 스코프에 등록 & 전역 객체 프로퍼티 메서드로 등록

2. 전역 코드 실행: 
   
   - 전역 변수에 값이 할당되고 함수 호출
   
   - 함수가 호출되면 전역 코드 실행 일시 중단 -> 함수 내부로 진입 

3. 함수 코드 평가
   
   - 매개변수와 지역 변수 선언문 먼저 실행 -> 지역 스코프에 등록
   
   - arguments 객체 생성, 지역스코프 등록
   
   - this 바인딩 결정

4- 함수 코드 실행 
   
   - 식별자를 스코프 체인을 통해 검색



실행 컨텍스트가 하는 일

- 소스코드를 실행하는 데 필요한 환경을 제공하고 코드의 실행 결과를 실제로 관리하는 영역

- 식별자를 등록하고 관리하는 스코프(렉시컬 환경)와 코드 실행 순서 관리를 구현한 내부 메커니즘(실행 컨텍스트 스택)

- 모든 코드는 실행 컨텍스트를 통해 실행되고 관리된다



## 23.4 실행 컨텍스트 스택

- 정의: 실행 컨텍스트는 **스택 ** 자료구조로 관리된다.

- 코드의 실행 순서를 관리: 코드 평가되면 실행 컨텍스트 생성 -> 스택 최상위 쌓임

- 최상위 실행 컨텍스트는 언제나 시실행중인 실행 컨텍스트(running execution context)



## 23.5 렉시컬 환경

- 식별자와 식별자에 바인딩된 값, 상위 스코프에 대한 참조를 기록하는 
  / 자료구조로 
  / 실행컨텍스트를 구성하는 컴포넌트

- 렉시컬 스코프의 실체가 렉시컬 환경



실행 컨텍스트와의 관계

- 실행 컨텍스트는 LexicalEnvironment 컴포넌트와 VariableEnvironment 컴포넌트로 구성

- (그렇지만 구분하지 않고 렉시컬 환경으로 통일해서 칭함)



렉시컬 환경의 구성

- Environment Record: 스코프에 포함된 식별자를 등록하고 식별자에 바인딩된 값을 관리하는 저장소

- OuterLexicalEnvironmentReference: 상위 스코프 



## 23.6 실행 컨텍스트의 생성과 식별자 검색 과정

[예제 23-04] 바탕으로 설명

### 1. 전역 객체 생성

- 전역 코드가 평가되기 이전에 생성

- 빌트인 전역 프로퍼티/함수, 표준 빌트인 객체 추가 

- 동작환경에 따라 클라이언트사이드 WebAPI(DOM, Canvas...) OR 호스트 객체 포함외부 렉시컬 환경에 대한 참조 결정 

- 전역 객체도 Object.prototype을 상속받는 프로토타입 체인의 일원

### 2. 전역 코드 평가

전역 코드 평가 순서

1. 전역 실행 컨텍스트 생성

2. 전역 렉시컬 환경 생성 
   -> 전역 실행 컨텍스트에 바인딩
   
   1. 전역 환경 레코드(Environment Record) 생성
      
      1. 객체 환경 레코드 생성
         -> var 전역 변수, 함수 선언문 전역 함수, 빌트인 전역 프로퍼티와 함수, 표준 빌트인 객체 관리
         -> 전역 객체 BindingObject와 연결(전역 변수 식별자를 키로 등록)
      
      2. 선언적 환경 레코드 생성
         -> let, const 키워드로 선언한 전역 변수
         -> 선언 단계와 초기화 단계가 분리되어 일시적 사각지대가 발생
   
   
   
   2. this 바인딩
      -> 전역 환경 레코드의 [[GlobalThisValue]] 내부 슬롯에 this 바인딩 
   
   3. 외부 렉시컬 환경에 대한 참조 결정
   - 
### 3. 전역 코드 실행

- 식별자 결정(어느 스코프의 식별자 참조할지)을 위해, 실행 중인 실행 컨텍스트에서 식별자 검색
  -> 검색을 실패한 식별자는 참조 에러 ReferenceError

### 4. foo 함수 코드 평가

1. 함수 실행 컨텍스트 생성

2. 함수 렉시컬 환경 생성
   
   1. 함수 환경 레코드 생성
      -> 매개변수, arguments 객체, 함수 내부에서 선언한 지역 변수와 중첩 함수 등록&관리
   
   2. this 바인딩
      -> [[ThisValue]] 내부 슬롯에 this 바인딩
   
   3. 외부 렉시컬 환경에 대한 참조 결정
      -> 함수 정의를 평가해 함수 객체 생성할 때 상위 스코프를 [[Environment]]에 저장

### 5. foo 함수 코드 실행

- 식별자 결정

### 6. bar 함수 코드 평가

- foo 함수 코드 평가와 과정 동일

### 7. bar 함수 코드 실행

- console.log(a + b+ x+ y + z);
  
  - console 식별자 검색
  
  - log 메서드 검색
  
  - 표현식 a+b+x+y+z 평가 
  
  - console.log 메서드 호출

### 8. bar 함수 실행 종료

- bar 렉시컬 환경은 누군가가 참조하고 있다면 남아있다

### 9. foo 함수 실행 종료

### 10. 전역 코드 실행 종료

전역 실행 컨텍스트도 pop -> 실행 컨텍스트 스택에서 아무것도 남아있지 않음



## 23.7 실행 컨텍스트와 블록 레벨 스코프

let, const 키워드로 선언한 변수는 모든 코드 블록(함수, if, for, while, try/catch 문 등)을 지역 스코프로 인정하는 블록 레벨 스코프를 따른다 












